<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Datamosher</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
            background-color: #f7f7f7;
        }
        h1 {
            color: #2a2a72;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #555;
            margin-bottom: 30px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .upload-container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .videos-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .video-panels {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .video-panel {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .panel-title {
            text-align: center;
            margin-bottom: 15px;
            color: #2a2a72;
        }
        video {
            width: 100%;
            border-radius: 8px;
            background-color: #000;
        }
        #upload-btn {
            background-color: #2a2a72;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        #upload-btn:hover {
            background-color: #3a3a92;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 200px;
        }
        .control-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2a2a72;
        }
        label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        input[type="range"] {
            width: 60%;
        }
        button {
            background-color: #2a2a72;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #3a3a92;
        }
        .download-btn {
            background-color: #28a745;
        }
        .download-btn:hover {
            background-color: #218838;
        }
        .hidden {
            display: none;
        }
        .preset-btn {
            background-color: #6c757d;
            margin: 5px;
        }
        .preset-btn:hover {
            background-color: #5a6268;
        }
        #loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #2a2a72;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .info-box {
            background-color: #e8f4f8;
            border-left: 4px solid #2a2a72;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }
        #error-message {
            color: #dc3545;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Video Datamosher</h1>
    <p class="subtitle">Upload a video and apply cool glitch effects</p>
    
    <div class="container">
        <div class="info-box">
            <p>Datamoshing creates glitchy visual effects by manipulating video compression artifacts. 
            The process works best with videos that have distinct motion and scene changes.</p>
            <p><strong>Tips:</strong> Try the preset effects first, then experiment with custom settings. 
            Higher I-frame drop rates create more intense glitches.</p>
        </div>

        <div class="upload-container">
            <h2>Upload Your Video</h2>
            <p>Select a video file to datamosh (MP4 format recommended)</p>
            <input type="file" id="video-input" accept="video/*" />
            <button id="upload-btn">Process Video</button>
            <p id="error-message"></p>
            
            <div id="loading">
                <p>Processing video... This may take a moment.</p>
                <div class="spinner"></div>
            </div>
        </div>

        <div class="videos-container hidden" id="result-container">
            <div class="video-panels">
                <div class="video-panel">
                    <h3 class="panel-title">Original Video</h3>
                    <video id="original-video" controls></video>
                </div>
                <div class="video-panel">
                    <h3 class="panel-title">Datamoshed Video</h3>
                    <video id="datamoshed-video" controls></video>
                    <button id="download-btn" class="download-btn">Download Result</button>
                </div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <div class="control-title">Presets</div>
                    <div>
                        <button class="preset-btn" data-preset="light">Light Glitch</button>
                        <button class="preset-btn" data-preset="medium">Medium Glitch</button>
                        <button class="preset-btn" data-preset="heavy">Heavy Glitch</button>
                        <button class="preset-btn" data-preset="extreme">Extreme Glitch</button>
                    </div>
                </div>
                
                <div class="control-group">
                    <div class="control-title">Custom Settings</div>
                    <label>
                        I-frame Drop Rate:
                        <input type="range" id="iframe-drop" min="0" max="100" value="50" />
                        <span id="iframe-value">50%</span>
                    </label>
                    <label>
                        P-frame Blend:
                        <input type="range" id="pframe-blend" min="0" max="100" value="30" />
                        <span id="pframe-value">30%</span>
                    </label>
                    <label>
                        Color Shift:
                        <input type="range" id="color-shift" min="0" max="100" value="20" />
                        <span id="color-value">20%</span>
                    </label>
                    <button id="apply-custom">Apply Custom Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM elements
        const videoInput = document.getElementById('video-input');
        const uploadBtn = document.getElementById('upload-btn');
        const originalVideo = document.getElementById('original-video');
        const datamoshedVideo = document.getElementById('datamoshed-video');
        const resultContainer = document.getElementById('result-container');
        const downloadBtn = document.getElementById('download-btn');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        
        // Sliders and values
        const iframeDropSlider = document.getElementById('iframe-drop');
        const pframeBlendSlider = document.getElementById('pframe-blend');
        const colorShiftSlider = document.getElementById('color-shift');
        const iframeValue = document.getElementById('iframe-value');
        const pframeValue = document.getElementById('pframe-value');
        const colorValue = document.getElementById('color-value');
        const applyCustomBtn = document.getElementById('apply-custom');
        const presetBtns = document.querySelectorAll('.preset-btn');
        
        // Variables to store video data
        let originalVideoBlob = null;
        let datamoshedVideoBlob = null;
        let videoWidth = 640;
        let videoHeight = 360;
        let canvas = null;
        let ctx = null;
        let frameData = [];
        
        // Canvas for processing video frames
        function initCanvas(width, height) {
            canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            ctx = canvas.getContext('2d');
        }
        
        // Update slider values
        iframeDropSlider.addEventListener('input', () => {
            iframeValue.textContent = `${iframeDropSlider.value}%`;
        });
        
        pframeBlendSlider.addEventListener('input', () => {
            pframeValue.textContent = `${pframeBlendSlider.value}%`;
        });
        
        colorShiftSlider.addEventListener('input', () => {
            colorValue.textContent = `${colorShiftSlider.value}%`;
        });
        
        // Handle file selection
        videoInput.addEventListener('change', (e) => {
            errorMessage.textContent = '';
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                if (file.type.startsWith('video/')) {
                    originalVideoBlob = file;
                    const objectURL = URL.createObjectURL(file);
                    originalVideo.src = objectURL;
                } else {
                    errorMessage.textContent = 'Please select a valid video file.';
                }
            }
        });
        
        // Process video when upload button is clicked
        uploadBtn.addEventListener('click', () => {
            if (!originalVideoBlob) {
                errorMessage.textContent = 'Please select a video file first.';
                return;
            }
            
            loading.style.display = 'block';
            errorMessage.textContent = '';
            
            // Set up video metadata listener
            originalVideo.onloadedmetadata = () => {
                videoWidth = originalVideo.videoWidth;
                videoHeight = originalVideo.videoHeight;
                
                // If video is too large, scale it down
                if (videoWidth > 1280) {
                    const scale = 1280 / videoWidth;
                    videoWidth = 1280;
                    videoHeight = Math.floor(videoHeight * scale);
                }
                
                initCanvas(videoWidth, videoHeight);
                extractFrames();
            };
            
            // Load video
            originalVideo.src = URL.createObjectURL(originalVideoBlob);
        });
        
        // Extract frames from video
        function extractFrames() {
            frameData = [];
            originalVideo.currentTime = 0;
            
            const seekInterval = 0.1; // Extract frames every 0.1 seconds
            let currentTime = 0;
            
            // Listen for seeking events
            originalVideo.addEventListener('seeked', function frameExtractor() {
                // Draw current frame to canvas
                ctx.drawImage(originalVideo, 0, 0, videoWidth, videoHeight);
                
                // Get frame data
                const imageData = ctx.getImageData(0, 0, videoWidth, videoHeight);
                frameData.push(new Uint8ClampedArray(imageData.data));
                
                // Move to next frame
                currentTime += seekInterval;
                
                if (currentTime < originalVideo.duration) {
                    originalVideo.currentTime = currentTime;
                } else {
                    // We've extracted all frames
                    originalVideo.removeEventListener('seeked', frameExtractor);
                    // Apply datamosh effect with default settings
                    applyDatmoshEffect(50, 30, 20);
                }
            });
            
            // Start extraction
            originalVideo.currentTime = 0;
        }
        
        // Apply datamosh effect
        function applyDatmoshEffect(iframeDrop, pframeBlend, colorShift) {
            if (frameData.length < 2) {
                errorMessage.textContent = 'Video is too short to process.';
                loading.style.display = 'none';
                return;
            }
            
            // Make copies of original frames
            const processedFrames = [];
            let lastIFrame = new Uint8ClampedArray(frameData[0]);
            
            // Process each frame
            for (let i = 0; i < frameData.length; i++) {
                // Determine if this is an I-frame (keyframe)
                const isIFrame = i === 0 || 
                                 i % 10 === 0 || 
                                 Math.random() * 100 > iframeDrop;
                                 
                if (isIFrame) {
                    // Keep this I-frame
                    lastIFrame = new Uint8ClampedArray(frameData[i]);
                    processedFrames.push(new Uint8ClampedArray(frameData[i]));
                } else {
                    // This is a P-frame, blend with previous
                    const blendedFrame = new Uint8ClampedArray(frameData[i].length);
                    
                    // Apply P-frame blending and color shifting
                    for (let j = 0; j < frameData[i].length; j += 4) {
                        const blendFactor = Math.random() * pframeBlend / 100;
                        
                        // RGB values
                        blendedFrame[j] = frameData[i][j] * (1 - blendFactor) + lastIFrame[j] * blendFactor;
                        blendedFrame[j+1] = frameData[i][j+1] * (1 - blendFactor) + lastIFrame[j+1] * blendFactor;
                        blendedFrame[j+2] = frameData[i][j+2] * (1 - blendFactor) + lastIFrame[j+2] * blendFactor;
                        
                        // Alpha channel
                        blendedFrame[j+3] = 255;
                        
                        // Apply color shift
                        if (Math.random() * 100 < colorShift) {
                            // Randomly swap color channels
                            const temp = blendedFrame[j];
                            blendedFrame[j] = blendedFrame[j+1];
                            blendedFrame[j+1] = blendedFrame[j+2];
                            blendedFrame[j+2] = temp;
                        }
                    }
                    
                    processedFrames.push(blendedFrame);
                }
            }
            
            // Render processed frames to video
            renderFramesToVideo(processedFrames);
        }
        
        // Render processed frames to video
        async function renderFramesToVideo(frames) {
            // Create a MediaRecorder to generate video from frames
            const stream = canvas.captureStream();
            const recorder = new MediaRecorder(stream, {
                mimeType: 'video/webm',
                videoBitsPerSecond: 5000000
            });
            
            const chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                datamoshedVideoBlob = blob;
                datamoshedVideo.src = URL.createObjectURL(blob);
                loading.style.display = 'none';
                resultContainer.classList.remove('hidden');
            };
            
            recorder.start();
            
            // Render each frame with delay
            const fps = 10;
            const frameTime = 1000 / fps;
            
            for (let i = 0; i < frames.length; i++) {
                // Create ImageData and put it on canvas
                const imgData = new ImageData(frames[i], videoWidth, videoHeight);
                ctx.putImageData(imgData, 0, 0);
                
                // Wait for the next frame time
                await new Promise(resolve => setTimeout(resolve, frameTime));
            }
            
            // Stop recording
            recorder.stop();
        }
        
        // Apply custom settings
        applyCustomBtn.addEventListener('click', () => {
            if (frameData.length === 0) {
                errorMessage.textContent = 'Please process a video first.';
                return;
            }
            
            loading.style.display = 'block';
            
            // Get values from sliders
            const iframeDrop = parseInt(iframeDropSlider.value);
            const pframeBlend = parseInt(pframeBlendSlider.value);
            const colorShift = parseInt(colorShiftSlider.value);
            
            // Apply effect with custom settings
            applyDatmoshEffect(iframeDrop, pframeBlend, colorShift);
        });
        
        // Handle presets
        presetBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (frameData.length === 0) {
                    errorMessage.textContent = 'Please process a video first.';
                    return;
                }
                
                loading.style.display = 'block';
                
                const preset = btn.dataset.preset;
                let iframeDrop, pframeBlend, colorShift;
                
                switch (preset) {
                    case 'light':
                        iframeDrop = 20;
                        pframeBlend = 15;
                        colorShift = 5;
                        break;
                    case 'medium':
                        iframeDrop = 50;
                        pframeBlend = 30;
                        colorShift = 20;
                        break;
                    case 'heavy':
                        iframeDrop = 75;
                        pframeBlend = 45;
                        colorShift = 35;
                        break;
                    case 'extreme':
                        iframeDrop = 90;
                        pframeBlend = 65;
                        colorShift = 50;
                        break;
                }
                
                // Update sliders to match preset
                iframeDropSlider.value = iframeDrop;
                pframeBlendSlider.value = pframeBlend;
                colorShiftSlider.value = colorShift;
                iframeValue.textContent = `${iframeDrop}%`;
                pframeValue.textContent = `${pframeBlend}%`;
                colorValue.textContent = `${colorShift}%`;
                
                // Apply effect with preset settings
                applyDatmoshEffect(iframeDrop, pframeBlend, colorShift);
            });
        });
        
        // Handle download
        downloadBtn.addEventListener('click', () => {
            if (!datamoshedVideoBlob) {
                return;
            }
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(datamoshedVideoBlob);
            a.download = 'datamoshed_video.webm';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
    </script>
</body>
</html>